<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cartas de Presentación IA (v5.5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .step-indicator { transition: all 0.3s ease-in-out; }
        .gemini-feature { border-left: 4px solid #4f46e5; background-color: #eef2ff; }
        .lang-toggle-label { width: 80px; height: 34px; background-color: #e5e7eb; border-radius: 9999px; cursor: pointer; display: flex; align-items: center; justify-content: space-around; position: relative; transition: background-color 0.3s; }
        .lang-toggle-label .ball { width: 30px; height: 30px; background-color: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.3s ease; }
        #lang-toggle:checked + .lang-toggle-label .ball { transform: translateX(46px); }
        #lang-toggle:checked + .lang-toggle-label { background-color: #4f46e5; }
        .slider-track { height: 4px; }
        .slider-thumb { width: 1.25rem; height: 1.25rem; }
        .ad-placeholder { background-color: #f3f4f6; border: 2px dashed #d1d5db; display: flex; align-items: center; justify-content: center; text-align: center; color: #6b7280; font-size: 0.875rem; }
        .notification { transition: opacity 0.3s; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900" data-lang-key="main_title">Asistente de Carrera IA</h1>
            <p class="text-md sm:text-lg text-gray-600 mt-2" data-lang-key="subtitle">Genera, analiza y gestiona tus postulaciones de trabajo.</p>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                <span class="font-semibold text-sm text-gray-600">ES</span>
                <input type="checkbox" id="lang-toggle" class="hidden">
                <label for="lang-toggle" class="lang-toggle-label"><div class="ball"></div></label>
                <span class="font-semibold text-sm text-gray-600">EN</span>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Columna Principal de la App -->
            <div class="w-full lg:w-2/3">
                <div class="w-full mb-8">
                    <div class="flex items-center justify-center">
                        <div id="step-indicator-1" class="step-indicator flex items-center justify-center w-10 h-10 bg-indigo-600 text-white rounded-full font-bold text-lg">1</div>
                        <div class="flex-auto border-t-2 border-gray-300 transition-colors duration-500 mx-4" id="step-line-1"></div>
                        <div id="step-indicator-2" class="step-indicator flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-500 rounded-full font-bold text-lg">2</div>
                        <div class="flex-auto border-t-2 border-gray-300 transition-colors duration-500 mx-4" id="step-line-2"></div>
                        <div id="step-indicator-3" class="step-indicator flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-500 rounded-full font-bold text-lg">3</div>
                        <div class="flex-auto border-t-2 border-gray-300 transition-colors duration-500 mx-4" id="step-line-3"></div>
                        <div id="step-indicator-4" class="step-indicator flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-500 rounded-full font-bold text-lg">4</div>
                    </div>
                </div>

                <main id="app-container">
                    <!-- Pasos de la aplicación aquí... -->
                    <div id="step-1" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
                        <div id="notification-1" class="notification hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg"></div>
                        <h2 class="text-2xl font-bold mb-6" data-lang-key="step1_title">Paso 1: Tu Información</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-indigo-700" data-lang-key="your_data">Tus Datos</h3>
                                <input id="fullName" type="text" data-lang-key-placeholder="placeholder_fullName" placeholder="Tu Nombre Completo" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
                                <input id="contactInfo" type="text" data-lang-key-placeholder="placeholder_contactInfo" placeholder="Email, Teléfono, LinkedIn (URL)" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-3 text-indigo-700" data-lang-key="profiles_title">Perfiles</h3>
                                <select id="profile-selector" class="w-full p-3 border border-gray-300 rounded-lg mb-2 bg-white"></select>
                                <input id="new-profile-name" type="text" data-lang-key-placeholder="placeholder_new_profile" placeholder="Nombre del nuevo perfil..." class="w-full p-3 border border-gray-300 rounded-lg mb-2">
                                <button onclick="saveProfile()" class="w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200" data-lang-key="save_profile_button">Guardar Perfil Actual</button>
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button onclick="validateAndGoTo(2)" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700" data-lang-key="next_button">Siguiente</button>
                        </div>
                    </div>

                    <div id="step-2" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden">
                        <div id="notification-2" class="notification hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg"></div>
                        <h2 class="text-2xl font-bold mb-6" data-lang-key="step2_title">Paso 2: La Oferta de Trabajo</h2>
                        <div class="mb-6">
                            <label for="jobTitle" class="block text-lg font-semibold mb-2" data-lang-key="job_title_label">Puesto al que Aplicas</label>
                            <input id="jobTitle" type="text" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label for="companyName" class="block text-lg font-semibold mb-2" data-lang-key="company_data">Nombre de la Empresa</label>
                            <input id="companyName" type="text" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <label for="jobDescription" class="block text-lg font-semibold mb-2" data-lang-key="job_desc_label">Descripción del Puesto</label>
                            <textarea id="jobDescription" rows="6" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="cvFile" class="block text-lg font-semibold mb-2" data-lang-key="upload_cv_label">Sube tu CV (PDF)</label>
                            <input type="file" id="cvFile" accept=".pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <p id="cv-status" class="text-sm text-green-600 mt-2 font-medium"></p>
                        </div>
                        <div class="mt-8 flex justify-between">
                            <button onclick="prevStep(1)" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg" data-lang-key="prev_button">Anterior</button>
                            <button onclick="validateAndGoTo(3)" class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" data-lang-key="next_button">Siguiente</button>
                        </div>
                    </div>

                    <div id="step-3" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden">
                        <div id="notification-3" class="notification hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg"></div>
                        <h2 class="text-2xl font-bold mb-6" data-lang-key="step3_title">Paso 3: Tu Valor y Tono</h2>
                        
                        <div class="gemini-feature p-4 rounded-lg mb-6">
                            <h3 class="font-bold text-indigo-800" data-lang-key="cv_extract_title">Extracción de Datos con IA</h3>
                            <p class="text-sm text-indigo-700 mb-2" data-lang-key="cv_extract_desc">Si subiste un CV, usa la IA para rellenar tus puntos fuertes y logros automáticamente.</p>
                            <button onclick="extractFromCv()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700" data-lang-key="cv_extract_button">✨ Extraer Datos del CV</button>
                            <div id="cvExtractResult" class="mt-4 text-sm hidden"></div>
                        </div>

                        <div class="mb-6">
                            <label for="strengths" class="block text-lg font-semibold mb-2" data-lang-key="strengths_label">Tus Puntos Fuertes</label>
                            <textarea id="strengths" rows="3" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="experience" class="block text-lg font-semibold mb-2" data-lang-key="experience_label">Tus Logros Clave</label>
                            <textarea id="experience" rows="4" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="whyCompany" class="block text-lg font-semibold mb-2" data-lang-key="why_company_label">¿Por qué esta empresa?</label>
                            <input id="whyCompany" type="text" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4" data-lang-key="tone_label_adv">Personalización Avanzada del Tono</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="formality" class="flex justify-between text-sm font-medium text-gray-700">
                                        <span data-lang-key="tone_formality">Formalidad</span>
                                        <span id="formality-value">50%</span>
                                    </label>
                                    <input id="formality" type="range" min="0" max="100" value="50" class="w-full slider-track">
                                </div>
                                <div>
                                    <label for="confidence" class="flex justify-between text-sm font-medium text-gray-700">
                                        <span data-lang-key="tone_confidence">Confianza</span>
                                        <span id="confidence-value">50%</span>
                                    </label>
                                    <input id="confidence" type="range" min="0" max="100" value="50" class="w-full slider-track">
                                </div>
                                <div>
                                    <label for="detail" class="flex justify-between text-sm font-medium text-gray-700">
                                        <span data-lang-key="tone_detail">Nivel de Detalle</span>
                                        <span id="detail-value">50%</span>
                                    </label>
                                    <input id="detail" type="range" min="0" max="100" value="50" class="w-full slider-track">
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-between">
                            <button onclick="prevStep(2)" class="bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg" data-lang-key="prev_button">Anterior</button>
                            <button onclick="generateCoverLetter()" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg flex items-center">
                                <span data-lang-key="generate_button">Generar Carta</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="loading" class="text-center p-8 hidden">
                         <div role="status" class="flex flex-col items-center justify-center">
                            <svg aria-hidden="true" class="w-12 h-12 mb-4 text-gray-200 animate-spin fill-indigo-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/><path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/></svg>
                            <h3 id="loading-text" class="text-xl font-semibold text-gray-700" data-lang-key="loading_text">Analizando...</h3>
                        </div>
                    </div>

                    <div id="step-4" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg hidden">
                        <h2 class="text-2xl font-bold mb-2" data-lang-key="step4_title">¡Tu Carta de Presentación está Lista!</h2>
                        <textarea id="coverLetterResult" rows="15" class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50"></textarea>
                        <div class="mt-6 flex flex-col sm:flex-row gap-4">
                            <button onclick="copyToClipboard()" class="w-full sm:w-auto flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" data-lang-key="copy_button">Copiar</button>
                            <button onclick="exportToPDF()" class="w-full sm:w-auto flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-lg" data-lang-key="export_button">Exportar PDF</button>
                        </div>
                        <div class="mt-6 text-center">
                           <button onclick="startOver()" class="text-indigo-600 hover:text-indigo-800 font-semibold" data-lang-key="start_over_button">Crear Nueva Carta</button>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Columna Lateral: Historial y Publicidad -->
            <aside class="w-full lg:w-1/3 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4" data-lang-key="history_title">Historial de Cartas</h2>
                <div id="history-list" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- El historial se llenará aquí -->
                </div>
                <div class="mt-6">
                     <h3 class="text-lg font-bold mb-2 text-gray-600" data-lang-key="ad_title">Publicidad</h3>
                     <div id="ad-placeholder-sidebar" class="ad-placeholder w-full h-64 rounded-lg">
                         <!-- Adsterra Square Banner (300x250) Code Goes Here -->
                         <span data-lang-key="ad_placeholder_text">Espacio Publicitario</span>
                     </div>
                </div>
            </aside>
        </div>

        <!-- Banner de Publicidad Inferior -->
        <footer class="mt-8">
            <div id="ad-placeholder-bottom" class="ad-placeholder w-full h-24 rounded-lg max-w-4xl mx-auto">
                <!-- Adsterra Horizontal Banner (728x90) Code Goes Here -->
                <span data-lang-key="ad_placeholder_text">Espacio Publicitario</span>
            </div>
        </footer>
    </div>

    <script>
    // --- V5.5 ---
    // Corregido guardado/carga de datos personales en perfiles y robustez en parseo de JSON de la IA.
    
    // --- Estado y Configuración ---
    let currentStep = 1;
    let currentLanguage = 'es';
    let appData = {
        profiles: {},
        history: [],
        currentInputs: {}
    };

    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

    const uiStrings = {
        es: {
            main_title: "Asistente de Carrera IA",
            subtitle: "Genera, analiza y gestiona tus postulaciones de trabajo.",
            step1_title: "Paso 1: Tu Información",
            your_data: "Tus Datos",
            profiles_title: "Perfiles",
            placeholder_fullName: "Tu Nombre Completo",
            placeholder_contactInfo: "Email, Teléfono, LinkedIn (URL)",
            placeholder_new_profile: "Nombre del nuevo perfil...",
            save_profile_button: "Guardar/Actualizar Perfil",
            next_button: "Siguiente",
            prev_button: "Anterior",
            step2_title: "Paso 2: La Oferta de Trabajo",
            job_title_label: "Puesto al que Aplicas",
            company_data: "Nombre de la Empresa",
            job_desc_label: "Descripción del Puesto",
            upload_cv_label: "Sube tu CV (PDF)",
            cv_extract_title: "Extracción de Datos con IA",
            cv_extract_desc: "Si subiste un CV, usa la IA para rellenar tus puntos fuertes y logros automáticamente.",
            cv_extract_button: "✨ Extraer Datos del CV",
            step3_title: "Paso 3: Tu Valor y Tono",
            strengths_label: "Tus Puntos Fuertes",
            experience_label: "Tus Logros Clave",
            why_company_label: "¿Por qué esta empresa?",
            tone_label_adv: "Personalización Avanzada del Tono",
            tone_formality: "Formalidad",
            tone_confidence: "Confianza",
            tone_detail: "Nivel de Detalle",
            generate_button: "Generar Carta",
            loading_text: "Analizando...",
            step4_title: "¡Tu Carta de Presentación está Lista!",
            copy_button: "Copiar",
            export_button: "Exportar PDF",
            start_over_button: "Crear Nueva Carta",
            history_title: "Historial de Cartas",
            ad_title: "Publicidad",
            ad_placeholder_text: "Espacio Publicitario",
            cv_loading: "Cargando y analizando CV...",
            cv_success: "✅ CV cargado y analizado.",
            cv_error: "Error al procesar el PDF.",
            cv_select_pdf: "Selecciona un archivo PDF.",
            cv_extract_error: "Sube tu CV primero para usar esta función.",
            cv_extract_success: "Datos extraídos. Por favor, revísalos y ajústalos si es necesario.",
            validation_error_step1: "Por favor, introduce tu nombre completo.",
            validation_error_step2: "Por favor, completa el título del puesto y la descripción.",
            error_prefix: "Error: ",
            copied_alert: "¡Texto copiado!",
            copy_error_alert: "No se pudo copiar.",
            profile_saved: "Perfil guardado: ",
            no_history: "Aún no has generado ninguna carta.",
            load_history_item: "Cargar",
            delete_history_item: "Borrar",
            confirm_delete: "¿Seguro que quieres borrar este elemento?"
        },
        en: {
            main_title: "AI Career Assistant",
            subtitle: "Generate, analyze, and manage your job applications.",
            step1_title: "Step 1: Your Information",
            your_data: "Your Details",
            profiles_title: "Profiles",
            placeholder_fullName: "Your Full Name",
            placeholder_contactInfo: "Email, Phone, LinkedIn (URL)",
            placeholder_new_profile: "New profile name...",
            save_profile_button: "Save/Update Profile",
            next_button: "Next",
            prev_button: "Previous",
            step2_title: "Step 2: The Job Offer",
            job_title_label: "Job Title You're Applying For",
            company_data: "Company Name",
            job_desc_label: "Job Description",
            upload_cv_label: "Upload Your CV (PDF)",
            cv_extract_title: "AI Data Extraction",
            cv_extract_desc: "If you uploaded a CV, use AI to automatically fill in your strengths and achievements.",
            cv_extract_button: "✨ Extract Data from CV",
            step3_title: "Step 3: Your Value & Tone",
            strengths_label: "Your Key Strengths",
            experience_label: "Your Key Achievements",
            why_company_label: "Why this company?",
            tone_label_adv: "Advanced Tone Personalization",
            tone_formality: "Formality",
            tone_confidence: "Confidence",
            tone_detail: "Level of Detail",
            generate_button: "Generate Letter",
            loading_text: "Analyzing...",
            step4_title: "Your Cover Letter is Ready!",
            copy_button: "Copy",
            export_button: "Export PDF",
            start_over_button: "Create New Letter",
            history_title: "Letter History",
            ad_title: "Advertisement",
            ad_placeholder_text: "Advertisement Space",
            cv_loading: "Loading and analyzing CV...",
            cv_success: "✅ CV successfully loaded and analyzed.",
            cv_error: "Error processing PDF.",
            cv_select_pdf: "Please select a PDF file.",
            cv_extract_error: "Upload your CV first to use this feature.",
            cv_extract_success: "Data extracted. Please review and adjust if necessary.",
            validation_error_step1: "Please enter your full name.",
            validation_error_step2: "Please complete the job title and description.",
            error_prefix: "Error: ",
            copied_alert: "Text copied!",
            copy_error_alert: "Could not copy.",
            profile_saved: "Profile saved: ",
            no_history: "You haven't generated any letters yet.",
            load_history_item: "Load",
            delete_history_item: "Delete",
            confirm_delete: "Are you sure you want to delete this item?"
        }
    };

    // --- Funciones de UI y Navegación ---
    function setLanguage(lang) {
        currentLanguage = lang;
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            if (uiStrings[lang][key]) el.textContent = uiStrings[lang][key];
        });
        document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
            const key = el.getAttribute('data-lang-key-placeholder');
            if (uiStrings[lang][key]) el.placeholder = uiStrings[lang][key];
        });
    }

    document.getElementById('lang-toggle').addEventListener('change', (e) => setLanguage(e.target.checked ? 'en' : 'es'));

    function showNotification(step, message, isError = true) {
        const notificationEl = document.getElementById(`notification-${step}`);
        if (!notificationEl) return;
        notificationEl.textContent = message;
        notificationEl.classList.remove('hidden');
        notificationEl.classList.toggle('bg-red-100', isError);
        notificationEl.classList.toggle('border-red-500', isError);
        notificationEl.classList.toggle('text-red-700', isError);
        notificationEl.classList.toggle('bg-green-100', !isError);
        notificationEl.classList.toggle('border-green-500', !isError);
        notificationEl.classList.toggle('text-green-700', !isError);
    }

    function hideNotification(step) {
        const notificationEl = document.getElementById(`notification-${step}`);
        if (notificationEl) notificationEl.classList.add('hidden');
    }

    function validateAndGoTo(nextStepNum) {
        hideNotification(currentStep);
        let isValid = true;
        let errorMessage = '';

        if (currentStep === 1) {
            if (!document.getElementById('fullName').value.trim()) {
                isValid = false;
                errorMessage = uiStrings[currentLanguage].validation_error_step1;
            }
        } else if (currentStep === 2) {
            if (!document.getElementById('jobTitle').value.trim() || !document.getElementById('jobDescription').value.trim()) {
                isValid = false;
                errorMessage = uiStrings[currentLanguage].validation_error_step2;
            }
        }

        if (isValid) {
            showStep(nextStepNum);
        } else {
            showNotification(currentStep, errorMessage);
        }
    }

    function updateStepIndicator(step) {
        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const line = document.getElementById(`step-line-${i-1}`);
            if (i <= step) {
                indicator.classList.add('bg-indigo-600', 'text-white');
                indicator.classList.remove('bg-gray-300', 'text-gray-500');
                if (line) line.classList.replace('border-gray-300', 'border-indigo-600');
            } else {
                indicator.classList.add('bg-gray-300', 'text-gray-500');
                indicator.classList.remove('bg-indigo-600', 'text-white');
                if (line) line.classList.replace('border-indigo-600', 'border-gray-300');
            }
        }
    }

    function showStep(step) {
        const currentStepEl = document.getElementById(`step-${currentStep}`);
        if(currentStepEl) currentStepEl.classList.add('hidden');
        
        const nextStepEl = document.getElementById(`step-${step}`);
        if(nextStepEl) nextStepEl.classList.remove('hidden');
        
        currentStep = step;
        updateStepIndicator(step);
        window.scrollTo(0, 0);
    }

    function prevStep(step) { showStep(step); }

    function startOver() {
        appData.currentInputs = {};
        const fields = ['fullName', 'contactInfo', 'jobTitle', 'companyName', 'jobDescription', 'strengths', 'experience', 'whyCompany', 'coverLetterResult', 'cvFile'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = '';
        });
        document.getElementById('cv-status').textContent = '';
        hideNotification(1);
        hideNotification(2);
        hideNotification(3);
        showStep(1);
    }

    // --- Lógica de Datos (localStorage) ---
    function saveState() {
        localStorage.setItem('careerAssistantData_v5', JSON.stringify(appData));
    }

    function loadState() {
        const savedData = localStorage.getItem('careerAssistantData_v5');
        if (savedData) {
            appData = JSON.parse(savedData);
        }
        if (!appData.profiles || Object.keys(appData.profiles).length === 0) {
            appData.profiles = { 'Default': { fullName: '', contactInfo: '', strengths: '', experience: '' } };
        }
        if(!appData.history) appData.history = [];

        updateProfileSelector();
        updateHistoryList();
    }

    // --- Perfiles ---
    function saveProfile() {
        const profileName = document.getElementById('new-profile-name').value.trim() || document.getElementById('profile-selector').value;
        if (!profileName) return;
        // CORRECCIÓN: Guardar también los datos personales en el perfil
        appData.profiles[profileName] = {
            fullName: document.getElementById('fullName').value,
            contactInfo: document.getElementById('contactInfo').value,
            strengths: document.getElementById('strengths').value,
            experience: document.getElementById('experience').value
        };
        document.getElementById('new-profile-name').value = '';
        updateProfileSelector(profileName);
        saveState();
        alert(uiStrings[currentLanguage].profile_saved + profileName);
    }

    function loadProfile(profileName) {
        const profile = appData.profiles[profileName];
        if (profile) {
            // CORRECCIÓN: Cargar también los datos personales del perfil
            document.getElementById('fullName').value = profile.fullName || '';
            document.getElementById('contactInfo').value = profile.contactInfo || '';
            document.getElementById('strengths').value = profile.strengths || '';
            document.getElementById('experience').value = profile.experience || '';
        }
    }

    function updateProfileSelector(selectedProfileName = 'Default') {
        const selector = document.getElementById('profile-selector');
        selector.innerHTML = '';
        Object.keys(appData.profiles).forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            selector.appendChild(option);
        });
        if (appData.profiles[selectedProfileName]) {
            selector.value = selectedProfileName;
        } else if (Object.keys(appData.profiles).length > 0) {
            selector.value = Object.keys(appData.profiles)[0];
        }
        loadProfile(selector.value);
    }
    
    document.getElementById('profile-selector').addEventListener('change', (e) => loadProfile(e.target.value));

    // --- Historial ---
    function addToHistory(letterData) {
        appData.history.unshift(letterData);
        if (appData.history.length > 20) appData.history.pop();
        updateHistoryList();
        saveState();
    }

    function updateHistoryList() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        if (appData.history.length === 0) {
            list.innerHTML = `<p class="text-gray-500 text-sm">${uiStrings[currentLanguage].no_history}</p>`;
            return;
        }
        appData.history.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'p-3 border rounded-lg flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <p class="font-semibold">${item.jobTitle}</p>
                    <p class="text-sm text-gray-600">${item.companyName} - ${new Date(item.date).toLocaleDateString()}</p>
                </div>
                <div>
                    <button onclick="loadFromHistory(${index})" class="text-sm bg-gray-200 px-2 py-1 rounded mr-1">${uiStrings[currentLanguage].load_history_item}</button>
                    <button onclick="deleteFromHistory(${index})" class="text-sm bg-red-200 px-2 py-1 rounded">${uiStrings[currentLanguage].delete_history_item}</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function loadFromHistory(index) {
        const item = appData.history[index];
        if (item) {
            startOver();
            document.getElementById('fullName').value = item.inputs.fullName;
            document.getElementById('contactInfo').value = item.inputs.contactInfo;
            document.getElementById('jobTitle').value = item.jobTitle;
            document.getElementById('companyName').value = item.companyName;
            document.getElementById('jobDescription').value = item.inputs.jobDescription;
            document.getElementById('strengths').value = item.inputs.strengths;
            document.getElementById('experience').value = item.inputs.experience;
            document.getElementById('whyCompany').value = item.inputs.whyCompany;
            document.getElementById('coverLetterResult').value = item.letter;
            showStep(4);
        }
    }

    function deleteFromHistory(index) {
        if (confirm(uiStrings[currentLanguage].confirm_delete)) {
            appData.history.splice(index, 1);
            updateHistoryList();
            saveState();
        }
    }

    // --- Lógica de PDF ---
    document.getElementById('cvFile').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        const statusEl = document.getElementById('cv-status');
        if (!file) return;
        statusEl.textContent = uiStrings[currentLanguage].cv_loading;
        try {
            const arrayBuffer = await file.arrayBuffer();
            const typedarray = new Uint8Array(arrayBuffer);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let textContent = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                textContent += text.items.map(s => s.str).join(' ');
            }
            appData.currentInputs.cvText = textContent;
            statusEl.textContent = uiStrings[currentLanguage].cv_success;
        } catch (error) {
            statusEl.textContent = uiStrings[currentLanguage].cv_error;
        }
    });

    // --- Funciones de IA ---
    async function callGemini(prompt, resultDivId) {
        const resultDiv = document.getElementById(resultDivId);
        if(resultDiv) {
            resultDiv.innerHTML = uiStrings[currentLanguage].loading_text;
            resultDiv.classList.remove('hidden');
        }

        const apiKey = "AIzaSyB-Bp2nEH0_srXgIzjizeQuiBLBF63oWZY"; 
        if (apiKey === "YOUR_API_KEY_HERE") {
            throw new Error("API Key not configured. Please add your Google AI Studio API Key to the code.");
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);
            const result = await response.json();
            return result.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("Gemini API Error:", error);
            if(resultDiv) resultDiv.innerHTML = `${uiStrings[currentLanguage].error_prefix}${error.message}`;
            throw error;
        }
    }
    
    async function extractFromCv() {
        const cvText = appData.currentInputs.cvText;
        if (!cvText) {
            showNotification(3, uiStrings[currentLanguage].cv_extract_error);
            return;
        }
        hideNotification(3);
        const resultDiv = document.getElementById('cvExtractResult');

        // CORRECCIÓN: Prompt más estricto para que devuelva solo el JSON.
        const prompt = `Act as an HR expert. Read the following CV text and extract the candidate's key strengths and quantifiable achievements. YOU MUST RESPOND ONLY WITH A VALID JSON OBJECT, with no extra text or markdown. The JSON object must have two keys: "strengths" (a string summarizing top skills) and "achievements" (a string summarizing key results, preferably with numbers). The response must be in ${currentLanguage === 'es' ? 'Spanish' : 'English'}. CV Text: \n\n${cvText}`;

        try {
            const resultText = await callGemini(prompt, 'cvExtractResult');
            // CORRECCIÓN: Lógica de parseo más robusta para encontrar el JSON.
            const jsonMatch = resultText.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error("No valid JSON object found in the AI response.");
            }
            const resultJson = JSON.parse(jsonMatch[0]);
            document.getElementById('strengths').value = resultJson.strengths || '';
            document.getElementById('experience').value = resultJson.achievements || '';
            resultDiv.textContent = uiStrings[currentLanguage].cv_extract_success;
        } catch (e) {
             if(resultDiv) resultDiv.innerHTML = `${uiStrings[currentLanguage].error_prefix}${e.message}`;
        }
    }

    async function generateCoverLetter() {
        const inputs = {
            fullName: document.getElementById('fullName').value,
            contactInfo: document.getElementById('contactInfo').value,
            jobTitle: document.getElementById('jobTitle').value,
            companyName: document.getElementById('companyName').value,
            jobDescription: document.getElementById('jobDescription').value,
            strengths: document.getElementById('strengths').value,
            experience: document.getElementById('experience').value,
            whyCompany: document.getElementById('whyCompany').value,
            cvText: appData.currentInputs.cvText || 'Not provided',
            formality: document.getElementById('formality').value,
            confidence: document.getElementById('confidence').value,
            detail: document.getElementById('detail').value,
        };
        appData.currentInputs = {...appData.currentInputs, ...inputs};

        if (!inputs.jobTitle || !inputs.jobDescription) {
            showNotification(3, uiStrings[currentLanguage].validation_error_step2);
            return;
        }
        hideNotification(3);

        document.getElementById('step-3').classList.add('hidden');
        document.getElementById('loading').classList.remove('hidden');
        updateStepIndicator(4);

        const prompt = `
            Generate a cover letter in ${currentLanguage === 'es' ? 'Spanish' : 'English'}.
            Info:
            - Candidate: ${inputs.fullName} (${inputs.contactInfo})
            - Company: ${inputs.companyName}
            - Position: ${inputs.jobTitle}
            - Job Description: ${inputs.jobDescription}
            - CV Summary: ${inputs.cvText}
            - Strengths: ${inputs.strengths}
            - Achievements: ${inputs.experience}
            - Motivation: ${inputs.whyCompany}
            - Tone - Formality: ${inputs.formality}%, Confidence: ${inputs.confidence}%, Detail: ${inputs.detail}%.
            Instructions: Write ONLY the letter text, ready to use.
        `;

        try {
            const letterText = await callGemini(prompt, null);
            document.getElementById('coverLetterResult').value = letterText;
            
            const historyItem = {
                jobTitle: inputs.jobTitle,
                companyName: inputs.companyName,
                date: new Date().toISOString(),
                letter: letterText,
                inputs: appData.currentInputs
            };
            addToHistory(historyItem);

            showStep(4);
        } catch (e) {
            console.error("Error generating cover letter:", e);
            showNotification(3, `${uiStrings[currentLanguage].error_prefix}${e.message}`);
            showStep(3);
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    // --- Acciones de Resultado ---
    function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('coverLetterResult').value)
            .then(() => alert(uiStrings[currentLanguage].copied_alert))
            .catch(() => alert(uiStrings[currentLanguage].copy_error_alert));
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const text = document.getElementById('coverLetterResult').value;
        const fullName = document.getElementById('fullName').value || 'candidate';
        const margin = 20;
        const lineHeight = 7;
        
        doc.setFont("Helvetica", "normal");
        doc.setFontSize(11);

        const lines = doc.splitTextToSize(text, doc.internal.pageSize.getWidth() - margin * 2);
        let y = margin;
        lines.forEach(line => {
            if (y + lineHeight > doc.internal.pageSize.getHeight() - margin) {
                doc.addPage();
                y = margin;
            }
            doc.text(line, margin, y);
            y += lineHeight;
        });

        doc.save(`Cover_Letter_${fullName.replace(/\s/g, '_')}.pdf`);
    }

    // --- Inicialización ---
    document.querySelectorAll('input[type="range"]').forEach(slider => {
        const valueSpan = document.getElementById(`${slider.id}-value`);
        slider.addEventListener('input', () => valueSpan.textContent = `${slider.value}%`);
    });

    loadState();
    setLanguage('es');
    showStep(1);

    </script>
</body>
</html>
